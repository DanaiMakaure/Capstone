<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Student Insights Panel</title>

<!-- Bootstrap CSS for style -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    background-color: #1e1e2f;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #61dafb;
    margin-bottom: 40px;
  }
  .upload-section {
    max-width: 600px;
    margin: 0 auto 30px auto;
    background: #2c2c47;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.7);
  }
  input[type="file"] {
    color: #eee;
  }
  .btn-primary {
    background: linear-gradient(135deg, #61dafb, #1a9ed8);
    border: none;
    font-weight: 600;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #53c7ff, #1582cc);
  }
  #message {
    margin-top: 15px;
    text-align: center;
  }
  .table-container {
    margin-top: 40px;
    max-width: 1000px;
    margin-left: auto;
    margin-right: auto;
  }
  table {
    background-color: #2c2c47;
    color: #eee;
    border-radius: 8px;
    overflow: hidden;
  }
  th {
    background-color: #3a3a61;
  }
  .at-risk {
    color: #ff6b6b;
    font-weight: bold;
  }
  .not-risk {
    color: #4bc0c0;
    font-weight: bold;
  }
  .charts-container {
    max-width: 900px;
    margin: 50px auto 100px auto;
    text-align: center;
  }
  .charts-container h3 {
    color: #61dafb;
    margin-bottom: 20px;
  }
  progress {
    width: 100%;
    height: 25px;
  }
  .chart-row {
    display: flex;
    justify-content: center;
    gap: 40px;
    flex-wrap: wrap;
    margin-bottom: 40px;
  }
  .chart-box {
    flex: 1 1 400px;
    max-width: 450px;
  }
</style>
</head>
<body>

<h1>Student Insights Panel</h1>

<div class="upload-section">
  <label for="studentNumberInput" class="form-label">Enter Your Student Number to Login</label>
  <input id="studentNumberInput" class="form-control mb-3" type="text" placeholder="e.g. 202300316" />
  <button id="loginBtn" class="btn btn-primary w-100 mb-4">Login</button>

  <form id="uploadForm" style="display:none;">
    <div class="mb-3">
      <label for="fileInput" class="form-label">Upload Your Marks (.csv or .xlsx)</label>
      <input class="form-control" type="file" id="fileInput" accept=".csv,.xls,.xlsx" required />
    </div>
    <button type="submit" class="btn btn-primary w-100">Upload & Update</button>
  </form>
  <div id="message"></div>
</div>

<div class="table-container">
  <table class="table table-bordered table-striped text-center" id="studentTable" style="table-layout: fixed;">
    <thead>
      <tr>
        <th style="width:12%;">Student Number</th>
        <th style="width:20%;">Full Name</th>
        <th style="width:15%;">Module Name</th>
        <th style="width:12%;">Type</th>
        <th style="width:8%;">Number</th>
        <th style="width:8%;">Score</th>
        <th style="width:10%;">AVG</th>
        <th style="width:15%;">Feedback</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div class="charts-container" style="display:none;">
  <h3>Your Performance Visuals</h3>
  <div class="chart-row">
    <div class="chart-box">
      <canvas id="lineChart" style="max-width: 100%;"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="radarChart" style="max-width: 100%;"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="pieChart" style="max-width: 100%;"></canvas>
    </div>
  </div>
  <div style="max-width: 700px; margin: 0 auto;">
    <label for="improvementBar" style="color:#61dafb; font-weight:600;">Improvement Progress</label>
    <progress id="improvementBar" value="0" max="100"></progress>
  </div>
</div>

<script>
let loggedInStudentNumber = null;
const loginBtn = document.getElementById("loginBtn");
const studentNumberInput = document.getElementById("studentNumberInput");
const uploadForm = document.getElementById("uploadForm");
const fileInput = document.getElementById("fileInput");
const message = document.getElementById("message");
const tableBody = document.getElementById("tableBody");
const chartsContainer = document.querySelector(".charts-container");

let accumulatedData = [];
let lineChart, radarChart, pieChart;

loginBtn.addEventListener("click", () => {
  const studentNum = studentNumberInput.value.trim();
  if (!studentNum) {
    message.textContent = "Please enter your student number to login.";
    message.style.color = "#ff6b6b";
    return;
  }
  setLoggedInStudentNumber(studentNum);
});

function setLoggedInStudentNumber(studentNum) {
  loggedInStudentNumber = studentNum;
  accumulatedData = [];
  message.textContent = `Logged in as ${studentNum}. Loading your data...`;
  message.style.color = "#61dafb";

  uploadForm.style.display = "block";
  chartsContainer.style.display = "block";

  fileInput.value = "";
  tableBody.innerHTML = "";

  loadStudentData(studentNum);
}

async function loadStudentData(studentNum) {
  try {
    const res = await fetch(`http://localhost:8002/get_student_data/${studentNum}`);
    if (!res.ok) throw new Error(`Server returned ${res.status}`);
    const json = await res.json();

    if (json.data && Array.isArray(json.data) && json.data.length > 0) {
      accumulatedData = json.data;
      renderTable(accumulatedData);
      updateCharts(accumulatedData);
      message.textContent = `Loaded ${accumulatedData.length} records for ${studentNum}.`;
      message.style.color = "#61dafb";
    } else {
      message.textContent = "No prior data found. Please upload your marks.";
      message.style.color = "#eee";
    }
  } catch (err) {
    message.textContent = "Error loading data: " + err.message;
    message.style.color = "#ff6b6b";
  }
}

uploadForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!fileInput.files.length) {
    message.textContent = "Please select a file to upload.";
    message.style.color = "#ff6b6b";
    return;
  }

  if (!loggedInStudentNumber) {
    message.textContent = "Please login first by entering your student number.";
    message.style.color = "#ff6b6b";
    return;
  }

  message.textContent = "Uploading and processing...";
  message.style.color = "#eee";

  const formData = new FormData();
  formData.append("student_number", loggedInStudentNumber);
  formData.append("file", fileInput.files[0]);

  try {
    const response = await fetch("http://localhost:8002/upload_student_marks/", {
      method: "POST",
      body: formData
    });

    const result = await response.json();

    if (response.ok && result.data) {
      // Merge new entries without duplicates
      const newEntries = result.data.filter(newRow => {
        const key = `${newRow["Student Number"]}|${newRow["Module Name"]}|${newRow["Type"]}|${newRow["Number"]}`;
        return !accumulatedData.some(existingRow =>
          `${existingRow["Student Number"]}|${existingRow["Module Name"]}|${existingRow["Type"]}|${existingRow["Number"]}` === key
        );
      });

      accumulatedData = accumulatedData.concat(newEntries);
      accumulatedData.sort((a, b) => {
        if (a["Module Name"] < b["Module Name"]) return -1;
        if (a["Module Name"] > b["Module Name"]) return 1;
        if (a["Type"] < b["Type"]) return -1;
        if (a["Type"] > b["Type"]) return 1;
        return a["Number"] - b["Number"];
      });

      renderTable(accumulatedData);
      updateCharts(accumulatedData);

      message.textContent = `Upload successful. ${result.data.length} rows processed.`;
      message.style.color = "#61dafb";
    } else {
      message.textContent = result.error || result.message || "Upload failed.";
      message.style.color = "#ff6b6b";
    }
  } catch (err) {
    message.textContent = "Error uploading file: " + err.message;
    message.style.color = "#ff6b6b";
  }
});

function renderTable(data) {
  tableBody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row["Student Number"]}</td>
      <td>${row["Full Name"]}</td>
      <td>${row["Module Name"]}</td>
      <td>${row["Type"]}</td>
      <td>${row["Number"]}</td>
      <td>${row["Score"]}</td>
      <td>${row["AVG"]}</td>
      <td class="${row["Feedback"] === "At Risk" ? "at-risk" : "not-risk"}">${row["Feedback"]}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function updateCharts(data) {
  // Line Chart: AVG by Module and Type over Number
  const grouped = {};
  data.forEach(row => {
    const key = `${row["Module Name"]} - ${row["Type"]}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push({ x: Number(row["Number"]), y: Number(row["AVG"]) });
  });
  Object.values(grouped).forEach(arr => arr.sort((a, b) => a.x - b.x));

  const colors = ['#61dafb', '#4bc0c0', '#ff6384', '#ffa600', '#36a2eb'];
  const datasets = Object.entries(grouped).map(([label, points], i) => ({
    label,
    data: points,
    borderColor: colors[i % colors.length],
    fill: false,
    tension: 0.2,
  }));

  const ctxLine = document.getElementById('lineChart').getContext('2d');
  if (lineChart) {
    lineChart.data.datasets = datasets;
    lineChart.update();
  } else {
    lineChart = new Chart(ctxLine, {
      type: 'line',
      data: { datasets },
      options: {
        scales: {
          x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Number' } },
          y: { min: 0, max: 100, title: { display: true, text: 'Average Score (%)' } }
        },
        responsive: true,
        plugins: { legend: { position: 'top' } }
      }
    });
  }

  // Radar Chart: Average scores by Type
  const typeSum = {};
  const typeCount = {};
  data.forEach(r => {
    const t = r["Type"];
    typeSum[t] = (typeSum[t] || 0) + Number(r["Score"]);
    typeCount[t] = (typeCount[t] || 0) + 1;
  });
  const radarLabels = Object.keys(typeSum);
  const radarData = radarLabels.map(t => +(typeSum[t] / typeCount[t]).toFixed(1));

  const ctxRadar = document.getElementById('radarChart').getContext('2d');
  if (radarChart) {
    radarChart.data.labels = radarLabels;
    radarChart.data.datasets[0].data = radarData;
    radarChart.update();
  } else {
    radarChart = new Chart(ctxRadar, {
      type: 'radar',
      data: {
        labels: radarLabels,
        datasets: [{
          label: 'Average Scores by Type',
          data: radarData,
          fill: true,
          backgroundColor: 'rgba(97, 218, 251, 0.3)',
          borderColor: '#61dafb',
          pointBackgroundColor: '#61dafb',
        }]
      },
      options: {
        scales: {
          r: {
            min: 0,
            max: 100,
            ticks: { stepSize: 10 },
          }
        }
      }
    });
  }

  // Pie Chart: Feedback distribution ("At Risk" vs "Not at Risk")
  const feedbackCounts = data.reduce((acc, row) => {
    acc[row.Feedback] = (acc[row.Feedback] || 0) + 1;
    return acc;
  }, {});

  const pieLabels = Object.keys(feedbackCounts);
  const pieData = pieLabels.map(label => feedbackCounts[label]);

  const pieColors = ['#ff6b6b', '#4bc0c0'];

  const ctxPie = document.getElementById('pieChart').getContext('2d');
  if (pieChart) {
    pieChart.data.labels = pieLabels;
    pieChart.data.datasets[0].data = pieData;
    pieChart.update();
  } else {
    pieChart = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: pieLabels,
        datasets: [{
          label: 'Feedback Distribution',
          data: pieData,
          backgroundColor: pieColors,
          hoverOffset: 30
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'top',
            labels: { color: '#eee' }
          }
        },
        responsive: true
      }
    });
  }

  // Improvement progress bar: % of "Not at Risk"
  const total = data.length;
  const notAtRiskCount = data.filter(r => r.Feedback === "Not at Risk").length;
  const percent = total === 0 ? 0 : Math.round((notAtRiskCount / total) * 100);
  const progressBar = document.getElementById("improvementBar");
  progressBar.value = percent;
  // Add gradient effect
  progressBar.style.background = `linear-gradient(to right, #4bc0c0 ${percent}%, #2c2c47 ${percent}%)`;
}
</script>

</body>
</html>




